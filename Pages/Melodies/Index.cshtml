@page
@model Melodies25.Pages.Melodies.IndexModel
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    ViewData["Title"] = "Мелодії в Базі даних";
    var message = TempData["Message"]?.ToString();
    var lng = Model.SelectedLang;
    if (message is not null)
    {
        <script>
            alert('@message');
        </script>
    }
    var user = Model.User;
}
@section Styles {
    <link rel="stylesheet" href="~/css/melodies.details.css" asp-append-version="true" />
}
<div class="infocontainer hideformenu">
    <div class="spaceformenu"></div>
    <h1>@Localizer["MelodiesInDatabase", Model.TotalCount]</h1>
    <!--Верхній прямокутник-->
    <div class="d-flex flex-row melody-index-flex">
        <!-- Кнопки ліворуч "Пошук", "Додати мелодію" -->
        <div id="operationbuttons" class="d-flex flex-column me-4">
            <a asp-page="search" class="btn-melody m-2 btn-compact-40 align-self-start"><span class="hide-mobile">@Localizer["AdvancedSearch"]</span> <span class="show-mobile">@Localizer["Search"]</span></a>
            <a asp-page="Create" class="btn-melody m-2 btn-compact-40 align-self-start"><span class="hide-mobile">@Localizer["AddMelody"]</span><span class="show-mobile">@Localizer["Add"]</span></a>
        </div>

        <!-- гамбургер (поза блоком літер) -->
        <button id="lettersToggleBtn" class="letters-hamburger" type="button"
                aria-controls="lettersbutton" aria-expanded="false" title="Показати/Сховати літери">
            ☰ Літери
        </button>

        <!-- Кнопки з літерами праворуч -->
        <div id="lettersbutton" class="d-flex flex-column">
            <div class="d-flex flex-wrap gap-1 mb-2 letters-row">
                @foreach (var letter in Enumerable.Range('A', 26).Select(i => ((char)i).ToString()))
                {
                    var isSelected = Model.SelectedLetter == letter;
                    <form asp-page-handler="FilterByLetter" asp-route-letter="@letter" asp-route-sortOrder="@Model.CurrentSort" method="post">
                        <button type="submit" class="letter btn-melody @(isSelected ? "selected-letter" : "")">@letter</button>
                    </form>
                }
            </div>
            <div class="d-flex flex-wrap gap-1 mb-2 letters-row">
                @{
                    var ukrLetters = new[] { "А", "Б", "В", "Г", "Д", "Е", "Є", "Ж", "З", "І", "Ї", "К", "Л", "М", "Н", "О", "П", "Р", "С", "Т", "У", "Ф", "Х", "Ц", "Ч", "Ш", "Щ", "Ю", "Я" };
                }
                @foreach (var letter in ukrLetters)
                {
                    var isSelected = Model.SelectedLetter == letter;
                    <form asp-page-handler="FilterByLetter" asp-route-letter="@letter" method="post">
                        <button type="submit" class="letter btn-melody @(isSelected ? "selected-letter" : "")">@letter</button>
                    </form>
                }
                <form asp-page-handler="FilterByLetter" asp-route-letter="" method="post">
                    <button type="submit" class="letter btn-melody">показати усі</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- ТАБЛИЦЯ -->
<div class="table-responsive-custom">
    <table class="table">
        <thead>
            <tr>
                <!-- ENSURE SORT LINKS RESET TO PAGE 1, AND PAGINATION LINKS CARRY CURRENT SORT -->
                <th>
                    <a asp-page="./Index"
                       asp-route-sortOrder="@(Model.TitleSort)"
                       asp-route-letter="@Model.SelectedLetter"
                       asp-route-pageIndex="1"
                       class="link-light">
                        @Localizer["Title"]  @(Model.TitleSort == "title_asc" ? "▲" : "▼")
                    </a>
                </th>
                <th>
                    <a asp-page="./Index"
                       asp-route-sortOrder="@(Model.AuthorSort)"
                       asp-route-letter="@Model.SelectedLetter"
                       asp-route-pageIndex="1"
                       class="link-light">
                        @Localizer["Author"] @(Model.AuthorSort == "title_asc" ? "▲" : "▼")
                    </a>
                </th>
                <th>
                    @Localizer["File"]
                </th>
                @if (user.IsInRole("Admin") || user.IsInRole("Moderator"))
                {
                    <th class="col-actions">Редагувати/Вилучити</th>
                }
            </tr>

        </thead>
        <tbody>
            @foreach (var item in Model.Melody ?? Enumerable.Empty<Melodies25.Models.Melody>())
            {
                <tr>
                    <!--НАЗВА-->
                    <td>
                        <a asp-page="./Details" asp-route-id="@item.ID" class="link-dark">@Html.DisplayFor(modelItem => item.Title)</a>
                    </td>
                    <!--АВТОР-->
                    <td>
                        @if (item.Author is not null)
                        {
                            var authorId = item.Author.ID;
                            // Special-case display for Ukrainian folk song
                            if (string.Equals(item.Author.Surname, "Українська народна пісня", StringComparison.OrdinalIgnoreCase))
                            {
                                var displayText = lng == "uk" ? "Українська народна пісня" : "Ukrainian folk song";
                                <a asp-page="/Authors/Details" asp-route-id="@authorId" class="link-dark song-title" title="@displayText">
                                    @displayText
                                </a>
                            }
                            else
                            {
                                // Determine display name with fallbacks
                                string firstName = (lng == "uk") ? (item.Author.Name ?? item.Author.NameEn ?? string.Empty) : (item.Author.NameEn ?? item.Author.Name ?? string.Empty);
                                string lastName  = (lng == "uk") ? (item.Author.Surname ?? item.Author.SurnameEn ?? string.Empty) : (item.Author.SurnameEn ?? item.Author.Surname ?? string.Empty);

                                // Trim and ensure not empty
                                firstName = (firstName ?? string.Empty).Trim();
                                lastName = (lastName ?? string.Empty).Trim();

                                <a asp-page="/Authors/Details" asp-route-id="@authorId" class="link-dark">
                                    @if (!string.IsNullOrEmpty(firstName))
                                    {
                                        <span>@firstName</span>
                                    }
                                    @if (!string.IsNullOrEmpty(firstName) && !string.IsNullOrEmpty(lastName))
                                    {
                                        <span>&nbsp;</span>
                                    }
                                    @if (!string.IsNullOrEmpty(lastName))
                                    {
                                        <span>@lastName</span>
                                    }
                                </a>
                            }
                        }
                    </td>

                    <!-- ФАЙЛ -->
                    <td>
                        @if (!string.IsNullOrEmpty(item.FilePath))
                        {
                            var midifilepath = Url.Content($"~/melodies/{item.FilePath}");
                            var mp3filepath = Url.Content($"~/mp3/{item.Mp3Filepath}");
                            <div style="display:inline-flex">
                                @if (@item.IsFileEligible is null)
                                {
                                    <button class="btn-melody playButton"
                                            data-filepath="@item.FilePath" id="playButton_@item.FilePath">
                                        <i class="fas fa-play"><!--?--></i>
                                    </button>
                                    <button id="stopButton_@item.FilePath" disabled="disabled"
                                            class="stopButton btn-melody">
                                        <i class="fas fa-stop"><!--?--></i>
                                    </button>
                                }
                                else if (@item.IsFileEligible is true)
                                {
                                    <button class="btn-melody playButton"
                                            data-filepath="@item.FilePath" id="playButton_@item.FilePath">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button id="stopButton_@item.FilePath" disabled="disabled"
                                            class="stopButton btn-melody">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                }
                                else if (@item.IsFileEligible is false)
                                {
                                    <p>Midi File is not correct</p>
                                }
                                <audio id="audioPlayer_@item.FilePath" class="audioPlayer" controls style="display: none">
                                    <source src="@mp3filepath" type="audio/mpeg" />
                                    Your browser does not support the audio element.
                                </audio>
                            </div>
                        }
                        else
                        {
                            <span>Файл @item.FilePath не доступний</span>
                        }
                    </td>
                    <!-- ОПЕРАЦІЇ -->
                    @if (user.IsInRole("Admin") || user.IsInRole("Moderator"))
                    {
                        <td class="col-actions">
                            <a asp-page="./Edit" asp-route-id="@item.ID" class="link-dark"><i class="fas fa-edit"></i></a>
                            <a asp-page="./Delete" asp-route-id="@item.ID" class="link-danger" style="margin-left:50px"><i class="fas fa-remove"></i></a>
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- PAGINATION -->
@if (Model.TotalPages > 1)
{
    <nav aria-label="Page navigation">
        <ul class="pagination">
            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                var liClass = i == Model.PageIndex ? "page-item active" : "page-item";
                <li class="@liClass">
                    <a class="page-link" asp-page="./Index"
                       asp-route-pageIndex="@i"
                       asp-route-sortOrder="@Model.CurrentSort"
                       asp-route-letter="@Model.SelectedLetter">@i</a>
                </li>
            }
        </ul>
    </nav>
}

<div class="infocontainer actions-container melody-width">
    <div class="actions-row">
        <form method="post" class="m-0">
            <button type="submit" class="btn-melody link-dark">Оновити</button>
        </form>
        <form asp-page-handler="killdupes" method="post" class="m-0">
            <button type="submit" class="btn-melody link-dark">Вилучити Дублікати</button>
        </form>
    </div>
    <!-- control strip -->
    @if (User.IsInRole("Admin"))
    {
        <div class="control-strip" id="controlStrip" role="region" aria-label="Control strip" aria-expanded="false">
            <p>показати помилки</p>
            <button id="controlToggle" class="control-toggle" aria-controls="controlContent" aria-expanded="false" title="Розгорнути/Згорнути">+</button>
            <div id="controlContent" class="control-content" hidden>
                <div class="control-messages">
                    <p class="control-msg">@Model.Msg</p>
                    <p class="control-err">@Model.Errormsg</p>
                </div>
            </div>
        </div>
    }
</div>

<script src="~/js/play.js"></script>
<script src="~/js/melody-index.js" asp-append-version="true"></script>